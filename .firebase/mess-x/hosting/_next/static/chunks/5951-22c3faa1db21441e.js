"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5951],{30285:(e,t,a)=>{a.d(t,{$:()=>l,r:()=>d});var s=a(95155),r=a(12115),i=a(99708),n=a(74466),o=a(59434);let d=(0,n.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:brightness-90",destructive:"bg-destructive text-destructive-foreground hover:brightness-90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),l=r.forwardRef((e,t)=>{let{className:a,variant:r,size:n,asChild:l=!1,...m}=e,u=l?i.DX:"button";return(0,s.jsx)(u,{className:(0,o.cn)(d({variant:r,size:n,className:a})),ref:t,...m})});l.displayName="Button"},56104:(e,t,a)=>{a.d(t,{BV:()=>p,IG:()=>c,db:()=>u,j2:()=>m,yA:()=>l});var s=a(23915),r=a(93004),i=a(35317),n=a(90858),o=a(54177);let d={apiKey:"AIzaSyAE4clgZjZHdSuBgyfPvsSrRfCM_pBiVeg",authDomain:"mess-x.firebaseapp.com",projectId:"mess-x",storageBucket:"mess-x.firebasestorage.app",messagingSenderId:"1050676425130",appId:"1:1050676425130:web:522aaec85fd7fc98a5bbd3"},l=null,m=null,u=null,c=null,p=null;if(d.apiKey&&d.projectId){l=(0,s.Dk)().length?(0,s.Sx)():(0,s.Wp)(d),m=(0,r.xI)(l),u=(0,i.aU)(l),c=(0,n.c7)(l);try{p=(0,o.dG)(l)}catch(e){console.error("Failed to initialize Firebase Messaging:",e)}}else console.warn("Firebase configuration is missing or incomplete. Please create a .env.local file with your Firebase project credentials. Authentication features will be disabled.")},59434:(e,t,a)=>{a.d(t,{cn:()=>i});var s=a(52596),r=a(39688);function i(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,r.QP)((0,s.$)(t))}},66695:(e,t,a)=>{a.d(t,{BT:()=>l,Wu:()=>m,ZB:()=>d,Zp:()=>n,aR:()=>o,wL:()=>u});var s=a(95155),r=a(12115),i=a(59434);let n=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",a),...r})});n.displayName="Card";let o=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",a),...r})});o.displayName="CardHeader";let d=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("text-2xl font-semibold leading-none tracking-tight",a),...r})});d.displayName="CardTitle";let l=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("text-sm text-muted-foreground",a),...r})});l.displayName="CardDescription";let m=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("p-6 pt-0",a),...r})});m.displayName="CardContent";let u=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("flex items-center p-6 pt-0",a),...r})});u.displayName="CardFooter"},98905:(e,t,a)=>{a.d(t,{A1:()=>A,AS:()=>K,AV:()=>Q,Ce:()=>H,FO:()=>b,G1:()=>q,Gc:()=>L,JQ:()=>I,Ko:()=>v,OG:()=>Y,Oe:()=>D,Oq:()=>J,Q8:()=>N,SM:()=>o,Sh:()=>C,VM:()=>h,Wc:()=>S,Wz:()=>P,XV:()=>W,YG:()=>R,ZJ:()=>y,Zc:()=>M,b1:()=>j,bA:()=>m,cW:()=>T,ck:()=>G,eY:()=>z,eb:()=>es,eg:()=>f,f9:()=>p,fP:()=>c,gh:()=>w,he:()=>u,jA:()=>U,jn:()=>eo,k5:()=>B,kQ:()=>F,kd:()=>Z,lB:()=>_,nE:()=>X,oF:()=>ee,pR:()=>E,qX:()=>O,rM:()=>ed,ry:()=>x,tW:()=>V,te:()=>et,tj:()=>$,xb:()=>ea,xe:()=>g,yg:()=>l});var s=a(56104),r=a(35317),i=a(90858),n=a(93004);if(!s.db)throw Error("Firestore is not initialized. Please ensure your Firebase project credentials are set up correctly in your .env.local file and that the server has been restarted.");let o=async(e,t)=>{if(!s.db||!t)return;let a=(0,r.H9)(s.db,"users",e);try{await (0,r.mZ)(a,{fcmTokens:(0,r.hq)(t)})}catch(e){console.error("Error saving FCM token:",e)}},d=async(e,t)=>{if(s.db)try{let a=(0,r.rJ)(s.db,"messes",e,"notifications");await (0,r.gS)(a,{...t,read:!1,timestamp:(0,r.O5)()})}catch(e){console.error("Error creating notification:",e)}},l=(e,t,a,i)=>{let n;if(!s.db||!a)return()=>{};let o=(0,r.rJ)(s.db,"messes",e,"notifications");return n="manager"===a?(0,r.P)(o,(0,r._M)("userId","in",["manager",t])):(0,r.P)(o,(0,r._M)("userId","==",t)),(0,r.aQ)(n,e=>{let t=e.docs.map(e=>({id:e.id,...e.data()})),a=new Date;a.setDate(a.getDate()-30);let s=t.filter(e=>e.timestamp&&e.timestamp.toDate()>a);s.sort((e,t)=>{var a,s,r,i;let n=(null==(s=e.timestamp)||null==(a=s.toDate())?void 0:a.getTime())||0;return((null==(i=t.timestamp)||null==(r=i.toDate())?void 0:r.getTime())||0)-n}),i(s)},e=>console.error("Error on notifications snapshot:",e))},m=async(e,t)=>{if(s.db)try{let a=(0,r.H9)(s.db,"messes",e,"notifications",t);await (0,r.mZ)(a,{read:!0})}catch(e){throw console.error("Error marking notification as read:",e),e}},u=async(e,t,a)=>{if(s.db&&a)try{let i,n=(0,r.rJ)(s.db,"messes",e,"notifications");i="manager"===a?(0,r.P)(n,(0,r._M)("userId","in",["manager",t]),(0,r._M)("read","==",!1)):(0,r.P)(n,(0,r._M)("userId","==",t),(0,r._M)("read","==",!1));let o=await (0,r.GG)(i);if(o.empty)return;let d=(0,r.wP)(s.db);o.docs.forEach(e=>{d.update(e.ref,{read:!0})}),await d.commit()}catch(e){throw console.error("Error marking all notifications as read:",e),e}},c=async(e,t)=>{if(s.db)try{let a=(0,r.H9)(s.db,"messes",e,"notifications",t);await (0,r.kd)(a)}catch(e){throw console.error("Error deleting notification:",e),e}},p=async(e,t,a)=>{if(s.db&&a)try{let i,n=(0,r.rJ)(s.db,"messes",e,"notifications");i="manager"===a?(0,r.P)(n,(0,r._M)("userId","in",["manager",t])):(0,r.P)(n,(0,r._M)("userId","==",t));let o=await (0,r.GG)(i);if(o.empty)return;let d=(0,r.wP)(s.db);o.docs.forEach(e=>{d.delete(e.ref)}),await d.commit()}catch(e){throw console.error("Error deleting all notifications:",e),e}},b=async e=>{let t=(0,r.H9)(s.db,"users",e.uid),a=await (0,r.x7)(t),i={uid:e.uid,email:e.email,displayName:e.displayName,photoURL:e.photoURL};return a.exists()?await (0,r.mZ)(t,{displayName:e.displayName,photoURL:e.photoURL}):await (0,r.BN)(t,i,{merge:!0}),t},f=async(e,t)=>{let a;if(!s.db||!s.j2)throw Error("Firebase not initialized");let{displayName:o,newImageFile:d}=t,l=s.j2.currentUser;if(!l||l.uid!==e)throw Error("Authentication error.");let m=(0,r.H9)(s.db,"users",e),u=await h(e);if(d&&s.IG){let t=(0,i.KR)(s.IG,"profile-pictures/".concat(e,"/").concat(d.name)),r=await (0,i.D)(t,d);a=await (0,i.qk)(r.ref)}let c={},p={};if(o&&o!==l.displayName&&(c.displayName=o,p.displayName=o),a&&a!==l.photoURL&&(c.photoURL=a,p.photoURL=a),Object.keys(c).length>0&&await (0,n.r7)(l,c),Object.keys(p).length>0&&await (0,r.mZ)(m,p),(null==u?void 0:u.messId)&&o){let t=(0,r.H9)(s.db,"messes",u.messId,"members",e);(await (0,r.x7)(t)).exists()&&await (0,r.mZ)(t,{name:o})}return{...c}},g=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=Math.random().toString(36).substring(2,8).toUpperCase(),i=(0,r.wP)(s.db),n=(0,r.H9)((0,r.rJ)(s.db,"messes"));i.set(n,{name:e,managerId:t.uid,createdAt:(0,r.O5)(),inviteCode:a,mealSettings:{breakfastCutoff:"02:00",lunchCutoff:"13:00",dinnerCutoff:"20:00",isBreakfastOn:!0,isLunchOn:!0,isDinnerOn:!0,isCutoffEnabled:!0},summary:{totalExpenses:0,totalDeposits:0,totalMeals:0,mealRate:0}});let o=(0,r.H9)(s.db,"users",t.uid);i.update(o,{messId:n.id,role:"manager"});let d=(0,r.H9)(s.db,"messes",n.id,"members",t.uid);return i.set(d,{name:t.displayName,email:t.email,role:"manager",balance:0,meals:0}),await i.commit(),n.id},w=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=(0,r.rJ)(s.db,"messes"),i=(0,r.P)(a,(0,r._M)("inviteCode","==",e.toUpperCase()),(0,r.AB)(1)),n=await (0,r.GG)(i);if(n.empty)throw Error("Invalid invite code. No mess found.");let o=n.docs[0].id,l=await h(t.uid);if(null==l?void 0:l.messId)throw Error("You are already a member of a mess.");let m=(0,r.wP)(s.db),u=(0,r.H9)(s.db,"users",t.uid);m.update(u,{messId:o,role:"member"});let c=(0,r.H9)(s.db,"messes",o,"members",t.uid);return m.set(c,{name:t.displayName,email:t.email,role:"member",balance:0,meals:0}),await m.commit(),await d(o,{userId:"manager",message:"".concat(t.displayName||"A new member"," has joined the mess."),link:"/dashboard/members"}),o},h=async e=>{if(!s.db)throw Error("Firestore not initialized");let t=(0,r.H9)(s.db,"users",e),a=await (0,r.x7)(t);return a.exists()?a.data():null},y=async e=>{if(!s.db)throw Error("Firestore not initialized");let t=(0,r.H9)(s.db,"messes",e),a=await (0,r.x7)(t);return a.exists()?{id:a.id,...a.data()}:null},x=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");if(!t.trim())throw Error("Mess name cannot be empty.");let a=(0,r.H9)(s.db,"messes",e);await (0,r.mZ)(a,{name:t.trim()})},E=async e=>{if(!s.db)throw Error("Firestore not initialized");let t=(0,r.rJ)(s.db,"messes",e,"members"),a=(await (0,r.GG)(t)).docs,i=a.map(e=>h(e.id)),n=await Promise.all(i);return a.map((e,t)=>{var a,s;let r=e.data(),i=n[t];return{id:e.id,name:r.name||"Unnamed Member",role:r.role,balance:null!=(a=r.balance)?a:0,meals:null!=(s=r.meals)?s:0,avatar:(null==i?void 0:i.photoURL)||"https://placehold.co/40x40.png"}})},v=(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");let i=(0,r.H9)(s.db,"messes",e,"members",t);return(0,r.aQ)(i,async e=>{if(e.exists()){var s,r;let i=e.data(),n=await h(t);a({id:t,name:i.name||"Unnamed Member",role:i.role,balance:null!=(s=i.balance)?s:0,meals:null!=(r=i.meals)?r:0,avatar:(null==n?void 0:n.photoURL)||"https://placehold.co/40x40.png"})}else a(null)})},I=(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=(0,r.rJ)(s.db,"messes",e,"pendingDeposits"),i=(0,r.rJ)(s.db,"messes",e,"pendingExpenses"),n=0,o=0,d=()=>{t(n+o)},l=(0,r.aQ)(a,e=>{n=e.size,d()}),m=(0,r.aQ)(i,e=>{o=e.size,d()});return()=>{l(),m()}},M=async(e,t)=>{var a,i;if(!s.db)throw Error("Firestore not initialized");let n=(0,r.H9)(s.db,"messes",e,"members",t),o=await (0,r.x7)(n);if(!o.exists())return null;let d=await h(t),l=o.data();return{id:t,name:l.name||"Unnamed Member",role:l.role,balance:null!=(a=l.balance)?a:0,meals:null!=(i=l.meals)?i:0,avatar:(null==d?void 0:d.photoURL)||"https://placehold.co/40x40.png"}},k=e=>{if(!e)return new Date().toISOString();if("function"==typeof e.toDate)return e.toDate().toISOString();let t=new Date(e);return isNaN(t.getTime())?new Date().toISOString():t.toISOString()},G=async(e,t)=>{if(!s.db)return[];let a=(0,r.rJ)(s.db,"messes",e,"expenses"),i=(0,r.P)(a,(0,r.My)("date","desc"));return t&&(i=(0,r.P)(i,(0,r.AB)(t))),(await (0,r.GG)(i)).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},D=async(e,t)=>{if(!s.db)return[];let a=(0,r.rJ)(s.db,"messes",e,"deposits"),i=(0,r.P)(a,(0,r.My)("date","desc"));return t&&(i=(0,r.P)(i,(0,r.AB)(t))),(await (0,r.GG)(i)).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},H=async(e,t)=>{if(!s.db)return[];let a=(0,r.rJ)(s.db,"messes",e,"deposits"),i=(0,r.P)(a,(0,r._M)("userId","==",t),(0,r.My)("date","desc"));return(await (0,r.GG)(i)).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},N=async(e,t)=>{if(!s.db)return[];let a=(0,r.rJ)(s.db,"messes",e,"expenses"),i=(0,r.P)(a,(0,r._M)("userId","==",t),(0,r.My)("date","desc"));return(await (0,r.GG)(i)).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},F=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async i=>{let n=(0,r.H9)(s.db,"messes",e,"deposits",t.id),o=(0,r.H9)(s.db,"messes",e,"members",t.userId),d=(0,r.H9)(s.db,"messes",e),l=a-t.amount;i.update(o,{balance:(0,r.GV)(l)}),i.update(n,{amount:a}),i.update(d,{"summary.totalDeposits":(0,r.GV)(l)})})},S=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async a=>{let i=(0,r.H9)(s.db,"messes",e,"deposits",t.id),n=(0,r.H9)(s.db,"messes",e,"members",t.userId),o=(0,r.H9)(s.db,"messes",e);a.update(n,{balance:(0,r.GV)(-t.amount)}),a.delete(i),a.update(o,{"summary.totalDeposits":(0,r.GV)(-t.amount)})})},z=async(e,t,a,i)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async n=>{let o=(0,r.H9)(s.db,"messes",e,"expenses",t),d=(0,r.H9)(s.db,"messes",e),[l,m]=await Promise.all([n.get(o),n.get(d)]);if(!l.exists()||!m.exists())throw Error("Expense or Mess not found. MessId: ".concat(e,", ExpenseId: ").concat(t));let u=m.data().summary||{totalExpenses:0,totalMeals:0},c=a-l.data().amount,p=u.totalExpenses+c,b=u.totalMeals>0?p/u.totalMeals:0;n.update(o,{amount:a,description:i}),n.update(d,{"summary.totalExpenses":(0,r.GV)(c),"summary.mealRate":b})})},P=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async a=>{let i=(0,r.H9)(s.db,"messes",e,"expenses",t),n=(0,r.H9)(s.db,"messes",e),[o,d]=await Promise.all([a.get(i),a.get(n)]);if(!o.exists()||!d.exists())throw Error("Expense or Mess not found. MessId: ".concat(e,", ExpenseId: ").concat(t));let l=d.data().summary||{totalExpenses:0,totalMeals:0},m=o.data().amount,u=l.totalExpenses-m,c=l.totalMeals>0?u/l.totalMeals:0;a.delete(i),a.update(n,{"summary.totalExpenses":(0,r.GV)(-m),"summary.mealRate":c})})},O=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");let i=await h(t),n=(0,r.rJ)(s.db,"messes",e,"pendingDeposits");await (0,r.gS)(n,{type:"new",amount:a,userId:t,memberName:(null==i?void 0:i.displayName)||"Unknown Member",date:(0,r.O5)(),status:"pending"}),await d(e,{userId:"manager",message:"".concat(null==i?void 0:i.displayName," submitted a new deposit of ৳").concat(a," for review."),link:"/dashboard/review"})},B=async function(e,t,a,i){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(!s.db)throw Error("Firestore not initialized");let o=await h(t),l=(0,r.rJ)(s.db,"messes",e,"pendingExpenses"),m={type:"new",amount:a,description:i,userId:t,addedBy:(null==o?void 0:o.displayName)||"Unknown Member",date:(0,r.O5)(),status:"pending"};n&&(m.receiptUrl=n),await (0,r.gS)(l,m),await d(e,{userId:"manager",message:"".concat(null==o?void 0:o.displayName," submitted a new expense for '").concat(i,"' for review."),link:"/dashboard/review"})},J=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");let i=await h(t.userId),n=(0,r.rJ)(s.db,"messes",e,"pendingDeposits");await (0,r.gS)(n,{type:"edit",originalId:t.id,originalAmount:t.amount,amount:a,userId:t.userId,memberName:(null==i?void 0:i.displayName)||"Unknown Member",date:(0,r.O5)(),status:"pending"}),await d(e,{userId:"manager",message:"".concat(null==i?void 0:i.displayName," requested to edit a deposit."),link:"/dashboard/review"})},U=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=await h(t.userId),i=(0,r.rJ)(s.db,"messes",e,"pendingDeposits");await (0,r.gS)(i,{type:"delete",originalId:t.id,amount:t.amount,userId:t.userId,memberName:(null==a?void 0:a.displayName)||"Unknown Member",date:(0,r.O5)(),status:"pending"}),await d(e,{userId:"manager",message:"".concat(null==a?void 0:a.displayName," requested to delete a deposit."),link:"/dashboard/review"})},R=async(e,t,a,i)=>{if(!s.db)throw Error("Firestore not initialized");let n=await h(t.userId),o=(0,r.rJ)(s.db,"messes",e,"pendingExpenses");await (0,r.gS)(o,{type:"edit",originalId:t.id,originalData:{amount:t.amount,description:t.description},amount:a,description:i,userId:t.userId,addedBy:(null==n?void 0:n.displayName)||"Unknown Member",date:(0,r.O5)(),status:"pending"}),await d(e,{userId:"manager",message:"".concat(null==n?void 0:n.displayName," requested to edit an expense."),link:"/dashboard/review"})},j=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=await h(t.userId),i=(0,r.rJ)(s.db,"messes",e,"pendingExpenses");await (0,r.gS)(i,{type:"delete",originalId:t.id,amount:t.amount,description:t.description,userId:t.userId,addedBy:(null==a?void 0:a.displayName)||"Unknown Member",date:(0,r.O5)(),status:"pending"}),await d(e,{userId:"manager",message:"".concat(null==a?void 0:a.displayName," requested to delete an expense for '").concat(t.description,"'."),link:"/dashboard/review"})},V=async e=>{if(!s.db)return[];let t=(0,r.rJ)(s.db,"messes",e,"pendingDeposits");return(await (0,r.GG)((0,r.P)(t,(0,r.My)("date","desc")))).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},_=async e=>{if(!s.db)return[];let t=(0,r.rJ)(s.db,"messes",e,"pendingExpenses");return(await (0,r.GG)((0,r.P)(t,(0,r.My)("date","desc")))).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},L=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async a=>{let i=(0,r.H9)(s.db,"messes",e,"pendingDeposits",t.id),n=(0,r.H9)(s.db,"messes",e);if(!(await a.get(i)).exists())return void console.log("Pending deposit does not exist, likely already processed.");let o=t.type||"new",d=(0,r.H9)(s.db,"messes",e,"members",t.userId);if("new"===o){let i=(0,r.H9)((0,r.rJ)(s.db,"messes",e,"deposits")),{id:o,status:l,...m}=t;a.set(i,{...m,date:new Date(t.date),status:"approved",approvedAt:(0,r.O5)()}),a.update(d,{balance:(0,r.GV)(t.amount)}),a.update(n,{"summary.totalDeposits":(0,r.GV)(t.amount)})}else if("edit"===o){let i=(0,r.H9)(s.db,"messes",e,"deposits",t.originalId),o=await a.get(i);if(!o.exists())throw Error("Original deposit not found.");let l=t.amount-o.data().amount;a.update(i,{amount:t.amount}),a.update(d,{balance:(0,r.GV)(l)}),a.update(n,{"summary.totalDeposits":(0,r.GV)(l)})}else if("delete"===o){let i=(0,r.H9)(s.db,"messes",e,"deposits",t.originalId),o=await a.get(i);if(!o.exists())throw Error("Original deposit not found.");let l=o.data().amount;a.delete(i),a.update(d,{balance:(0,r.GV)(-l)}),a.update(n,{"summary.totalDeposits":(0,r.GV)(-l)})}a.delete(i)}),await d(e,{userId:t.userId,message:"Your deposit request of ৳".concat(t.amount," was approved."),link:"/dashboard"})},A=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=(0,r.H9)(s.db,"messes",e,"pendingDeposits",t),i=await (0,r.x7)(a);if(i.exists()){let t=i.data();await (0,r.kd)(a),await d(e,{userId:t.userId,message:"Your deposit request of ৳".concat(t.amount," was rejected.")})}},C=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async a=>{let i=(0,r.H9)(s.db,"messes",e,"pendingExpenses",t.id),n=(0,r.H9)(s.db,"messes",e),[o,d]=await Promise.all([a.get(i),a.get(n)]);if(!o.exists())return void console.warn("Pending expense ".concat(t.id," already processed."));if(!d.exists())throw Error("Mess not found for expense approval. MessId: ".concat(e));let l=t.type||"new",m=d.data().summary||{totalExpenses:0,totalMeals:0},u=m.totalExpenses,c=[];if("new"===l){let i=(0,r.H9)((0,r.rJ)(s.db,"messes",e,"expenses")),{id:n,status:o,...d}=t;c.push(()=>a.set(i,{...d,date:new Date(t.date),status:"approved",approvedAt:(0,r.O5)()})),u+=t.amount}else if("edit"===l){let i=(0,r.H9)(s.db,"messes",e,"expenses",t.originalId),n=await a.get(i);if(!n.exists())throw Error("Original expense not found for edit.");let o=n.data().amount,d=t.amount-o;c.push(()=>a.update(i,{amount:t.amount,description:t.description})),u+=d}else if("delete"===l){let i=(0,r.H9)(s.db,"messes",e,"expenses",t.originalId),n=await a.get(i);if(n.exists()){let e=n.data().amount;c.push(()=>a.delete(i)),u-=e}else console.warn("Original expense ".concat(t.originalId," not found for deletion, it might have been deleted already."))}let p=m.totalMeals>0?u/m.totalMeals:0;c.forEach(e=>e()),a.update(n,{"summary.totalExpenses":u,"summary.mealRate":p}),a.delete(i)}),await d(e,{userId:t.userId,message:"Your expense for '".concat(t.description,"' was approved."),link:"/dashboard"})},T=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=(0,r.H9)(s.db,"messes",e,"pendingExpenses",t),i=await (0,r.x7)(a);if(i.exists()){let t=i.data();await (0,r.kd)(a),await d(e,{userId:t.userId,message:'Your expense request for "'.concat(t.description,'" was rejected.')})}},Z=async(e,t,a,i)=>{if(!s.db)throw Error("Firestore not initialized");let n=(0,r.H9)(s.db,"messes",e,"members",t),o=(0,r.H9)((0,r.rJ)(s.db,"messes",e,"guestMealLog")),l=(0,r.H9)(s.db,"messes",e,"members",t,"meals",a),m=(i.breakfast||0)+(i.lunch||0)+(i.dinner||0);if(m<=0)throw Error("No guest meals to log.");let u=await h(t);await (0,r.c4)(s.db,async d=>{let c=(0,r.H9)(s.db,"messes",e),p=await d.get(c);if(!p.exists())throw Error("Mess not found. MessId: ".concat(e));let b=p.data().summary||{totalExpenses:0,totalMeals:0},f=b.totalMeals+m,g=f>0?b.totalExpenses/f:0;d.update(n,{meals:(0,r.GV)(m)}),d.set(l,{guestBreakfast:(0,r.GV)(i.breakfast||0),guestLunch:(0,r.GV)(i.lunch||0),guestDinner:(0,r.GV)(i.dinner||0)},{merge:!0}),d.update(c,{"summary.totalMeals":(0,r.GV)(m),"summary.mealRate":g}),d.set(o,{hostUserId:t,hostUserName:(null==u?void 0:u.displayName)||"Unknown",date:a,loggedAt:(0,r.O5)(),...i})}),await d(e,{userId:"manager",message:"".concat(null==u?void 0:u.displayName," logged ").concat(m," guest meal(s).")})},q=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");let a=(0,r.H9)(s.db,"messes",e);await (0,r.mZ)(a,{mealSettings:t})},Y=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");return W(e,t,new Date().toISOString().split("T")[0])},Q=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");await K(e,t,new Date().toISOString().split("T")[0],{...a,isSetByUser:!0})},W=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");let i=(0,r.H9)(s.db,"messes",e,"members",t,"meals",a),n=await (0,r.x7)(i);if(!n.exists())return{breakfast:0,lunch:0,dinner:0,guestBreakfast:0,guestLunch:0,guestDinner:0,isSetByUser:!1};{var o,d,l,m,u,c,p;let e=n.data();return{breakfast:null!=(o=e.breakfast)?o:0,lunch:null!=(d=e.lunch)?d:0,dinner:null!=(l=e.dinner)?l:0,isSetByUser:null!=(m=e.isSetByUser)&&m,guestBreakfast:null!=(u=e.guestBreakfast)?u:0,guestLunch:null!=(c=e.guestLunch)?c:0,guestDinner:null!=(p=e.guestDinner)?p:0}}},K=async(e,t,a,i)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async n=>{var o,d,l,m,u,c,p,b,f,g,w,h;let y=(0,r.H9)(s.db,"messes",e,"members",t),x=(0,r.H9)(s.db,"messes",e,"members",t,"meals",a),E=(0,r.H9)(s.db,"messes",e),[v,I]=await Promise.all([n.get(x),n.get(E)]);if(!I.exists())throw Error("Mess not found. MessId: ".concat(e));let M=I.data().summary||{totalExpenses:0,totalMeals:0},k=v.exists()?v.data():{breakfast:0,lunch:0,dinner:0,guestBreakfast:0,guestLunch:0,guestDinner:0,isSetByUser:!1},G=(k.breakfast||0)+(k.lunch||0)+(k.dinner||0),D=(null!=(d=null!=(o=i.breakfast)?o:k.breakfast)?d:0)+(null!=(m=null!=(l=i.lunch)?l:k.lunch)?m:0)+(null!=(c=null!=(u=i.dinner)?u:k.dinner)?c:0),H=(k.guestBreakfast||0)+(k.guestLunch||0)+(k.guestDinner||0),N=D+((null!=(b=null!=(p=i.guestBreakfast)?p:k.guestBreakfast)?b:0)+(null!=(g=null!=(f=i.guestLunch)?f:k.guestLunch)?g:0)+(null!=(h=null!=(w=i.guestDinner)?w:k.guestDinner)?h:0))-(G+H),F=M.totalMeals,S=M.mealRate;0!==N&&(F+=N,S=F>0?M.totalExpenses/F:0),n.set(x,i,{merge:!0}),0!==N&&(n.update(y,{meals:(0,r.GV)(N)}),n.update(E,{"summary.totalMeals":(0,r.GV)(N),"summary.mealRate":S}))})},X=async function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30;if(!s.db)throw Error("Firestore not initialized");let i=(0,r.rJ)(s.db,"messes",e,"members",t,"meals"),n=new Date;n.setDate(n.getDate()-a);let o=n.toISOString().split("T")[0],d=(0,r.P)(i,(0,r._M)((0,r.Fs)(),">=",o)),l=(await (0,r.GG)(d)).docs.map(e=>({date:e.id,...e.data()}));return l.sort((e,t)=>t.date.localeCompare(e.date)),l},$=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7;if(!s.db)throw Error("Firestore not initialized");let a=await E(e);if(!a.length)return[];let r=a.map(async a=>(await X(e,a.id,t)).map(e=>({...e,memberId:a.id,memberName:a.name}))),i=(await Promise.all(r)).flat();return i.sort((e,t)=>e.date>t.date?-1:e.date<t.date?1:e.memberName<t.memberName?-1:+(e.memberName>t.memberName)),i},ee=async e=>{if(!s.db)throw Error("Firestore not initialized");let t=new Date().toISOString().split("T")[0],a=(0,r.rJ)(s.db,"messes",e,"members"),i=(await (0,r.GG)((0,r.P)(a))).docs;0!==i.length&&await (0,r.c4)(s.db,async a=>{let n=(0,r.H9)(s.db,"messes",e),o=await a.get(n);if(!o.exists())throw Error("Mess not found");let d=i.map(a=>(0,r.H9)(s.db,"messes",e,"members",a.id,"meals",t)),l=await Promise.all(d.map(e=>a.get(e))),m=o.data(),u=0,c=[];if(i.forEach((e,t)=>{if(!l[t].exists()){var s,i,n;let o={breakfast:+(null!=m&&null!=(s=m.mealSettings)&&!!s.isBreakfastOn),lunch:+(null!=m&&null!=(i=m.mealSettings)&&!!i.isLunchOn),dinner:+(null!=m&&null!=(n=m.mealSettings)&&!!n.isDinnerOn),isSetByUser:!1,guestBreakfast:0,guestLunch:0,guestDinner:0},l=(o.breakfast||0)+(o.lunch||0)+(o.dinner||0);l>0&&(c.push(()=>a.update(e.ref,{meals:(0,r.GV)(l)})),u+=l),c.push(()=>a.set(d[t],o))}}),c.forEach(e=>e()),u>0){let e=m.summary||{totalExpenses:0,totalMeals:0},t=e.totalMeals+u,s=t>0?e.totalExpenses/t:0;a.update(n,{"summary.totalMeals":(0,r.GV)(u),"summary.mealRate":s})}})},et=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async i=>{let n=(0,r.H9)(s.db,"messes",e),o=(0,r.H9)(s.db,"messes",e,"members",t),d=(0,r.H9)(s.db,"messes",e,"members",a),l=(0,r.H9)(s.db,"users",t),m=(0,r.H9)(s.db,"users",a),u=await i.get(n);if(!u.exists()||u.data().managerId!==t)throw Error("You are not the manager of this mess or the mess does not exist.");i.update(n,{managerId:a}),i.update(o,{role:"member"}),i.update(d,{role:"manager"}),i.update(l,{role:"member"}),i.update(m,{role:"manager"})}),await d(e,{userId:a,message:"You have been made the new manager of the mess.",link:"/dashboard/settings"}),await d(e,{userId:t,message:"Your manager role has been transferred. You are now a member.",link:"/dashboard/settings"})},ea=async(e,t)=>{if(!s.db)throw Error("Firestore not initialized");await (0,r.c4)(s.db,async a=>{let i=(0,r.H9)(s.db,"messes",e,"members",t),n=(0,r.H9)(s.db,"users",t),[o,d]=await Promise.all([a.get(i),a.get(n)]);if(o.exists()){if("manager"===o.data().role)throw Error("A manager cannot be removed. Transfer the role first.");d.exists()&&a.update(n,{messId:"",role:""}),a.delete(i)}})},es=async e=>{if(!s.db||!(null===s.j2||void 0===s.j2?void 0:s.j2.currentUser))throw Error("Authentication required.");let t=(0,r.wP)(s.db),a=(0,r.H9)(s.db,"messes",e),i=await (0,r.x7)(a);if(!i.exists()||i.data().managerId!==s.j2.currentUser.uid)throw Error("You are not authorized to delete this mess.");let n=(0,r.rJ)(s.db,"messes",e,"members");for(let a of(await (0,r.GG)(n)).docs){let i=a.id,n=(0,r.rJ)(s.db,"messes",e,"members",i,"meals");(await (0,r.GG)(n)).docs.forEach(e=>t.delete(e.ref)),t.delete(a.ref);let o=(0,r.H9)(s.db,"users",i);t.update(o,{messId:"",role:""})}for(let a of["expenses","deposits","pendingExpenses","pendingDeposits","notifications","guestMealLog"]){let i=(0,r.rJ)(s.db,"messes",e,a);(await (0,r.GG)(i)).docs.forEach(e=>t.delete(e.ref))}t.delete(a),await t.commit()},er=async(e,t,a)=>{if(!s.db)return[];let i=new Date(t,a,1),n=new Date(t,a+1,0,23,59,59),o=(0,r.rJ)(s.db,"messes",e,"expenses"),d=(0,r.P)(o,(0,r._M)("date",">=",r.Dc.fromDate(i)),(0,r._M)("date","<=",r.Dc.fromDate(n)));return(await (0,r.GG)(d)).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},ei=async(e,t,a)=>{if(!s.db)return[];let i=new Date(t,a,1),n=new Date(t,a+1,0,23,59,59),o=(0,r.rJ)(s.db,"messes",e,"deposits"),d=(0,r.P)(o,(0,r._M)("date",">=",r.Dc.fromDate(i)),(0,r._M)("date","<=",r.Dc.fromDate(n)));return(await (0,r.GG)(d)).docs.map(e=>{let t=e.data();return{id:e.id,...t,date:k(t.date)}})},en=async(e,t,a,i)=>{if(!s.db)return{personalMeals:0,guestMeals:0};let n="".concat(a,"-").concat((i+1).toString().padStart(2,"0")),o=(0,r.rJ)(s.db,"messes",e,"members",t,"meals"),d=(0,r.P)(o,(0,r._M)((0,r.Fs)(),">=",n+"-01"),(0,r._M)((0,r.Fs)(),"<=",n+"-31")),l=await (0,r.GG)(d),m=0,u=0;return l.forEach(e=>{let t=e.data();m+=(t.breakfast||0)+(t.lunch||0)+(t.dinner||0),u+=(t.guestBreakfast||0)+(t.guestLunch||0)+(t.guestDinner||0)}),{personalMeals:m,guestMeals:u}},eo=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");let i="".concat(e,"_").concat(t,"_").concat(a),n=(0,r.H9)(s.db,"monthlyReports",i),o=await (0,r.x7)(n);if(o.exists())return console.log("Serving cached report for",i),o.data();console.log("Generating new report for",i);let[d,l,m]=await Promise.all([E(e),er(e,t,a),ei(e,t,a)]),u=l.reduce((e,t)=>e+t.amount,0),c=m.reduce((e,t)=>e+t.amount,0),p=d.map(s=>en(e,s.id,t,a)),b=await Promise.all(p),f=d.map((e,t)=>{let{personalMeals:a,guestMeals:s}=b[t];return{...e,monthlyPersonalMeals:a,monthlyGuestMeals:s,monthlyTotalMeals:a+s,monthlyDeposits:m.filter(t=>t.userId===e.id).reduce((e,t)=>e+t.amount,0)}}),g=f.reduce((e,t)=>e+t.monthlyTotalMeals,0),w=g>0?u/g:0,h=f.map(e=>{let t=e.monthlyTotalMeals*w,a=e.monthlyDeposits-t;return{memberId:e.id,memberName:e.name,avatar:e.avatar,totalMeals:e.monthlyTotalMeals,totalGuestMeals:e.monthlyGuestMeals,mealCost:t,totalDeposits:e.monthlyDeposits,finalBalance:a}}),y={month:new Date(t,a).toLocaleString("default",{month:"long"}),year:t,totalExpenses:u,totalDeposits:c,totalMeals:g,mealRate:w,memberReports:h,expenses:l,deposits:m};return await (0,r.BN)(n,y),y},ed=async(e,t,a)=>{if(!s.db)throw Error("Firestore not initialized");let i="".concat(e,"_").concat(t,"_").concat(a),n=(0,r.H9)(s.db,"monthlyReports",i);try{await (0,r.kd)(n),console.log("Cache for report ".concat(i," invalidated."))}catch(e){throw console.error("Error invalidating cache for report ".concat(i,":"),e),e}}}}]);